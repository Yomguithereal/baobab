/* baobab.js - Version: 1.0.0-rc1 - Author: Yomguithereal (Guillaume Plique) */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.Baobab=t()}}(function(){var t;return function e(t,r,n){function o(s,a){if(!r[s]){if(!t[s]){var h="function"==typeof require&&require;if(!a&&h)return h(s,!0);if(i)return i(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var c=r[s]={exports:{}};t[s][0].call(c.exports,function(e){var r=t[s][1][e];return o(r?r:e)},c,c.exports,e,t,r,n)}return r[s].exports}for(var i="function"==typeof require&&require,s=0;s<n.length;s++)o(n[s]);return o}({1:[function(t,e,r){var n=t("./src/baobab.js"),o=t("./src/helpers.js");Object.defineProperty(n,"version",{value:"1.0.0-rc1"}),n.getIn=o.getIn,e.exports=n},{"./src/baobab.js":4,"./src/helpers.js":7}],2:[function(t,e,r){e.exports={autoCommit:!0,asynchronous:!0,facets:{},validate:null,validationBehaviour:"rollback"}},{}],3:[function(e,r,n){(function(){"use strict";function e(t,e){var r,n={};for(r in t)n[r]=t[r];for(r in e)n[r]=e[r];return n}function o(t){return!(!t||"object"!=typeof t||Array.isArray(t)||t instanceof Function||t instanceof RegExp)}function i(t,e){t=t||[];var r,n,o=[];for(n=0,r=t.length;r>n;n++)t[n].fn!==e&&o.push(t[n]);return o}var s={once:"boolean",scope:"object"},a=0,h=function(){this._enabled=!0,this.unbindAll()};h.prototype.unbindAll=function(){return this._handlers={},this._handlersAll=[],this._handlersComplex=[],this},h.prototype.on=function(t,e,r){var n,i,h,u,c,l,f;if(o(t)){for(u in t)this.on(u,t[u],e);return this}for("function"==typeof t&&(r=e,e=t,t=null),c=[].concat(t),n=0,i=c.length;i>n;n++){if(u=c[n],f={order:a++,fn:e},"string"==typeof u)this._handlers[u]||(this._handlers[u]=[]),l=this._handlers[u];else if(u instanceof RegExp)l=this._handlersComplex,f.pattern=u;else{if(null!==u)throw Error("Emitter.on: invalid event.");l=this._handlersAll}for(h in r||{})s[h]&&(f[h]=r[h]);f.once&&(f.parent=l),l.push(f)}return this},h.prototype.once=function(){var t=Array.prototype.slice.call(arguments),r=t.length-1;return o(t[r])&&t.length>1?t[r]=e(t[r],{once:!0}):t.push({once:!0}),this.on.apply(this,t)},h.prototype.off=function(t,e){var r,n,s,a;if(1===arguments.length&&"function"==typeof t){e=arguments[0];for(s in this._handlers)this._handlers[s]=i(this._handlers[s],e),0===this._handlers[s].length&&delete this._handlers[s];this._handlersAll=i(this._handlersAll,e),this._handlersComplex=i(this._handlersComplex,e)}else if(1===arguments.length&&"string"==typeof t)delete this._handlers[t];else if(2===arguments.length){var h=[].concat(t);for(r=0,n=h.length;n>r;r++)a=h[r],this._handlers[a]=i(this._handlers[a],e),0===(this._handlers[a]||[]).length&&delete this._handlers[a]}else if(o(t))for(s in t)this.off(s,t[s]);return this},h.prototype.listeners=function(t){var e,r,n,o=this._handlersAll||[],i=!1;if(!t)throw Error("Emitter.listeners: no event provided.");for(o=o.concat(this._handlers[t]||[]),r=0,n=this._handlersComplex.length;n>r;r++)e=this._handlersComplex[r],~t.search(e.pattern)&&(i=!0,o.push(e));return this._handlersAll.length||i?o.sort(function(t,e){return t.order-e.order}):o.slice(0)},h.prototype.emit=function(t,e){if(!this._enabled)return this;if(o(t)){for(var r in t)this.emit(r,t[r]);return this}var n,i,s,a,h,u,c,l=[].concat(t),f=[];for(a=0,u=l.length;u>a;a++){for(i=this.listeners(l[a]),h=0,c=i.length;c>h;h++)s=i[h],n={type:l[a],target:this},arguments.length>1&&(n.data=e),s.fn.call("scope"in s?s.scope:this,n),s.once&&f.push(s);for(h=f.length-1;h>=0;h--)f[h].parent.splice(f[h].parent.indexOf(f[h]),1)}return this},h.prototype.kill=function(){this.unbindAll(),this._handlers=null,this._handlersAll=null,this._handlersComplex=null,this._enabled=!1},h.prototype.disable=function(){return this._enabled=!1,this},h.prototype.enable=function(){return this._enabled=!0,this},h.version="3.0.0","undefined"!=typeof n?("undefined"!=typeof r&&r.exports&&(n=r.exports=h),n.Emitter=h):"function"==typeof t&&t.amd?t("emmett",[],function(){return h}):this.Emitter=h}).call(this)},{}],4:[function(t,e,r){function n(t){return t+"$"+(new Date).getTime()+(""+Math.random()).replace("0.","")}function o(t,e){function r(t){this[t]=function(){var e=this.root[t].apply(this.root,arguments);return e instanceof i?this:e}}if(arguments.length<1&&(t={}),!(this instanceof o))return new o(t,e);if(!p.Object(t)&&!p.Array(t))throw Error("Baobab: invalid data.");if(s.call(this),this.options=u.shallowMerge(f,e),this._transaction={},this._future=void 0,this._cursors={},this._identity="[object Baobab]",this.data=u.deepClone(t),this.root=this.select([]),this.facets={},["get","set","unset","update"].forEach(r.bind(this)),!p.Object(this.options.facets))throw Error("Baobab: invalid facets.");for(var n in this.options.facets)this.addFacet(n,this.options.facets[n])}var i=t("./cursor.js"),s=t("emmett"),a=t("./watcher.js"),h=t("./facet.js"),u=t("./helpers.js"),c=t("./update.js"),l=t("./merge.js"),f=t("../defaults.js"),p=t("./type.js");u.inherits(o,s),o.prototype.addFacet=function(t,e){return this.facets[t]=this.createFacet(e),this},o.prototype.createFacet=function(t){return new h(this,t)},o.prototype.select=function(t){if(!t)throw Error("Baobab.select: invalid path.");if(arguments.length>1&&(t=u.arrayOf(arguments)),!p.Path(t))throw Error("Baobab.select: invalid path.");t=[].concat(t);var e,r=p.ComplexPath(t);r&&(e=u.solvePath(this.data,t,this));var o=t.map(function(t){return p.Function(t)?n("fn"):p.Object(t)?n("ob"):t}).join("|λ|");if(this._cursors[o])return this._cursors[o];var s=new i(this,t,e,o);return this._cursors[o]=s,s},o.prototype.stack=function(t){var e=this;if(!p.Object(t))throw Error("Baobab.update: wrong specification.");return this._transaction=l(t,this._transaction),this.options.autoCommit?this.options.asynchronous?(this._future||(this._future=setTimeout(e.commit.bind(e,null),0)),this):this.commit():this},o.prototype.commit=function(){var t=c(this.data,this._transaction,this.options),e=this.data;this._transaction={},this._future&&(this._future=clearTimeout(this._future));var r=this.options.validate,n=this.options.validationBehaviour;if("function"==typeof r){var o=r.call(this,e,t.data,t.log);if(o instanceof Error&&(this.emit("invalid",{error:o}),"rollback"===n))return this}return this.data=t.data,this.emit("update",{log:t.log,previousState:e}),this},o.prototype.watch=function(t){if(!p.Array(t)||t.some(function(t){return!p.Path(t)}))throw Error("Baobab.watch: invalid paths.");return new a(this,[].concat(t))},o.prototype.release=function(){var t;delete this.data,delete this._transaction;for(t in this._cursors)this._cursors[t].release();delete this._cursors;for(t in this.facets)this.facets[t].release();delete this.facets,this.kill()},o.prototype.toJSON=function(){return this.get()},o.prototype.toString=function(){return this._identity},e.exports=o},{"../defaults.js":2,"./cursor.js":5,"./facet.js":6,"./helpers.js":7,"./merge.js":8,"./type.js":9,"./update.js":10,"./watcher.js":11,emmett:3}],5:[function(t,e,r){function n(t,e,r,n){function o(t){if(i.isRecording()&&!i.undoing){var e=a.getIn(t,i.solvedPath,i.tree),r=a.deepClone(e);i.archive.add(r)}return i.undoing=!1,i.emit("update")}var i=this;s.call(this),e=e||[],this.tree=t,this.path=e,this.hash=n,this.archive=null,this.undoing=!1,this._identity="[object Cursor]",this.complexPath=!!r,this.solvedPath=this.complexPath?r:this.path,this.relevant=void 0!==this.get(),this.updateHandler=function(t){var e=t.data.log,r=t.data.previousState,n=!1;if(i.complexPath&&(i.solvedPath=a.solvePath(i.tree.data,i.path,i.tree)),!i.path.length)return o(r);i.solvedPath&&(n=a.solveUpdate(e,[i.solvedPath]));var s=void 0!==i.get();i.relevant?s&&n?o(r):s||(i.emit("irrelevant"),i.relevant=!1):s&&n&&(i.emit("relevant"),o(r),i.relevant=!0)};var h=!1;this._lazyBind=function(){h||(h=!0,i.tree.on("update",i.updateHandler))},this.on=a.before(this._lazyBind,this.on.bind(this)),this.once=a.before(this._lazyBind,this.once.bind(this)),this.complexPath&&this._lazyBind()}function o(t,e,r,n){if(arguments.length>5)throw Error("baobab.Cursor."+t+": too many arguments.");arguments.length<4&&(n=r,r=[]),r=r||[];var o=[].concat(r),i=a.solvePath(this.get(),o,this.tree);if(!i)throw Error("baobab.Cursor."+t+": could not solve dynamic path.");if(e){var s=this.get(i);if(!h[e](s))throw Error("baobab.Cursor."+t+": invalid target.")}var u={};u["$"+t]=n;var c=a.pathObject(i,u);return c}function i(t,e){n.prototype[t]=function(){var r=o.bind(this,t,e).apply(this,arguments);return this.update(r)}}var s=t("emmett"),a=t("./helpers.js"),h=(t("../defaults.js"),t("./type.js"));a.inherits(n,s),n.prototype.isRoot=function(){return!this.path.length},n.prototype.isLeaf=function(){return h.Primitive(this.get())},n.prototype.isBranch=function(){return!this.isLeaf()&&!this.isRoot()},n.prototype.root=function(){return this.tree.root()},n.prototype.select=function(t){if(arguments.length>1&&(t=a.arrayOf(arguments)),!h.Path(t))throw Error("baobab.Cursor.select: invalid path.");return this.tree.select(this.path.concat(t))},n.prototype.up=function(){return this.solvedPath&&this.solvedPath.length?this.tree.select(this.path.slice(0,-1)):null},n.prototype.left=function(){var t=+this.solvedPath[this.solvedPath.length-1];if(isNaN(t))throw Error("baobab.Cursor.left: cannot go left on a non-list type.");return t?this.tree.select(this.solvedPath.slice(0,-1).concat(t-1)):null},n.prototype.leftmost=function(){var t=+this.solvedPath[this.solvedPath.length-1];if(isNaN(t))throw Error("baobab.Cursor.leftmost: cannot go left on a non-list type.");return this.tree.select(this.solvedPath.slice(0,-1).concat(0))},n.prototype.right=function(){var t=+this.solvedPath[this.solvedPath.length-1];if(isNaN(t))throw Error("baobab.Cursor.right: cannot go right on a non-list type.");return t+1===this.up().get().length?null:this.tree.select(this.solvedPath.slice(0,-1).concat(t+1))},n.prototype.rightmost=function(){var t=+this.solvedPath[this.solvedPath.length-1];if(isNaN(t))throw Error("baobab.Cursor.right: cannot go right on a non-list type.");var e=this.up().get();return this.tree.select(this.solvedPath.slice(0,-1).concat(e.length-1))},n.prototype.down=function(){+this.solvedPath[this.solvedPath.length-1];return this.get()instanceof Array?this.tree.select(this.solvedPath.concat(0)):null},n.prototype.get=function(t){arguments.length>1&&(t=a.arrayOf(arguments));var e=this.solvedPath.concat([].concat(t||0===t?t:[]));return a.getIn(this.tree.data,e,this.tree)},i("set"),i("apply"),i("chain"),i("push","Array"),i("unshift","Array"),n.prototype.merge=function(t){if(!h.Object(t))throw Error("baobab.Cursor.merge: trying to merge a non-object.");var e=o.bind(this,"merge","Object").apply(this,arguments);return this.update(e)},n.prototype.unset=function(t){if(void 0===t&&this.isRoot())throw Error("baobab.Cursor.unset: cannot remove root node.");var e=o.bind(this,"unset",null).apply(this,[t,!0]);return this.update(e)},n.prototype.update=function(t,e){if(arguments.length<2)return this.tree.stack(a.pathObject(this.solvedPath,t)),this;var r=[].concat(t),n=a.solvePath(this.get(),r,this.tree);if(!n)throw Error("baobab.Cursor.update: could not solve dynamic path.");return this.tree.stack(a.pathObject(this.solvedPath.concat(n),e)),this},n.prototype.startRecording=function(t){if(t=t||5,1>t)throw Error("baobab.Cursor.startRecording: invalid maximum number of records.");return this.archive?this:(this._lazyBind(),this.archive=a.archive(t),this)},n.prototype.stopRecording=function(){return this.archive=null,this},n.prototype.undo=function(t){if(t=t||1,!this.isRecording())throw Error("baobab.Cursor.undo: cursor is not recording.");if(!h.PositiveInteger(t))throw Error("baobab.Cursor.undo: expecting a positive integer.");var e=this.archive.back(t);if(!e)throw Error("boabab.Cursor.undo: cannot find a relevant record ("+t+" back).");return this.undoing=!0,this.set(e)},n.prototype.isRecording=function(){return!!this.archive},n.prototype.hasHistory=function(){return!(!this.archive||!this.archive.get().length)},n.prototype.getHistory=function(){return this.archive?this.archive.get():[]},n.prototype.release=function(){this.tree.off("update",this.updateHandler),this.hash&&delete this.tree._cursors[this.hash],delete this.tree,delete this.path,delete this.solvedPath,delete this.archive,this.kill()},n.prototype.toJSON=function(){return this.get()},n.prototype.toString=function(){return this._identity},e.exports=n},{"../defaults.js":2,"./helpers.js":7,"./type.js":9,emmett:3}],6:[function(t,e,r){function n(t){return t}function o(t,e){function r(t){o[t]=l[t].bind(l)}var o=this,s=null,a=!1,h=e.get||n,u=e.cursors,c=Object.keys(u).map(function(t){return u[t]}),l=new i(t,c);["on","once","release"].forEach(r),this.get=function(){if(a)return s;var e={};for(var r in u)e[r]=t.get(u[r]);return s=h.call(null,e),a=!0,s},this.on("update",function(){a=!1})}{var i=t("./watcher.js");t("./helpers.js")}e.exports=o},{"./helpers.js":7,"./watcher.js":11}],7:[function(t,e,r){(function(r){function n(t){return Array.prototype.slice.call(t)}function o(t,e){return function(){t(),e.apply(null,arguments)}}function i(t,e,r){var o=n(arguments).slice(3);return e=+e,r=+r,t.slice(0,e).concat(t.slice(e+r).concat(o))}function s(t,e){var r,n={};for(r in t)n[r]=t[r];for(r in e)n[r]=e[r];return n}function a(t){var e=t.source,r="";return t.global&&(r+="g"),t.multiline&&(r+="m"),t.ignoreCase&&(r+="i"),t.sticky&&(r+="y"),t.unicode&&(r+="u"),new RegExp(e,r)}function h(t,e){if(!e||"object"!=typeof e||e instanceof Error||"ArrayBuffer"in r&&e instanceof ArrayBuffer)return e;if(_.Array(e)){if(t){var n,o,i=[];for(n=0,o=e.length;o>n;n++)i.push(P(e[n]));return i}return e.slice(0)}if(_.Date(e))return new Date(e.getTime());if(e instanceof RegExp)return a(e);if(_.Object(e)){var s,h={};e.constructor&&e.constructor!==Object&&(h=Object.create(e.constructor.prototype));for(s in e)e.hasOwnProperty(s)&&(h[s]=t?P(e[s]):e[s]);return h}return e}function u(t,e){return function(r){return e(t(r))}}function c(t,e){var r,n;for(r=0,n=t.length;n>r;r++)if(e(t[r]))return t[r]}function l(t,e){var r,n;for(r=0,n=t.length;n>r;r++)if(e(t[r]))return r;return-1}function f(t,e){var r,n=!0;if(!t)return!1;for(r in e)if(_.Object(e[r]))n=n&&f(t[r],e[r]);else if(_.Array(e[r]))n=n&&!!~e[r].indexOf(t[r]);else if(t[r]!==e[r])return!1;return n}function d(t,e){return c(t,function(t){return f(t,e)})}function y(t,e){return l(t,function(t){return f(t,e)})}function v(t,e,r){e=e||[];var n,o,i,s=t;for(o=0,i=e.length;i>o;o++){if(!s)return;if("function"==typeof e[o]){if(!_.Array(s))return;s=c(s,e[o])}else if("object"==typeof e[o])if(r&&"$cursor"in e[o]){if(!_.Path(e[o].$cursor))throw Error("baobab.getIn: $cursor path must be an array.");n=r.get(e[o].$cursor),s=s[n]}else{if(!_.Array(s))return;s=d(s,e[o])}else s=s[e[o]]}return s}function g(t,e,r){var n,o,i,s=[],a=t;for(o=0,i=e.length;i>o;o++){if(!a)return null;if("function"==typeof e[o]){if(!_.Array(a))return;n=l(a,e[o]),s.push(n),a=a[n]}else if("object"==typeof e[o])if(r&&"$cursor"in e[o]){if(!_.Path(e[o].$cursor))throw Error("baobab.getIn: $cursor path must be an array.");p=r.get(e[o].$cursor),s.push(p),a=a[p]}else{if(!_.Array(a))return;n=y(a,e[o]),s.push(n),a=a[n]}else s.push(e[o]),a=a[e[o]]||{}}return s}function b(t,e){var r,n,o,i,s,a,h,u,c;for(r=0,i=e.length;i>r;r++)for(h=e[r],n=0,s=t.length;s>n;n++)for(u=t[n],o=0,a=u.length;a>o&&(c=u[o],c==h[o]);o++)if(o+1===a||o+1===h.length)return!0;return!1}function m(t,e){var r,n=t.length,o={},i=o;for(n||(o=e),r=0;n>r;r++)i[t[r]]=r+1===n?e:{},i=i[t[r]];return o}function j(t,e){t.super_=e;var r=function(){};r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t}function w(t){var e=[];return{add:function(r){e.unshift(r),e.length>t&&(e.length=t)},back:function(t){var r=e[t-1];return r&&(e=e.slice(t)),r},get:function(){return e}}}var _=t("./type.js"),$=h.bind(null,!1),P=h.bind(null,!0);e.exports={archive:w,arrayOf:n,before:o,deepClone:P,shallowClone:$,shallowMerge:s,compose:u,getIn:v,inherits:j,pathObject:m,solvePath:g,solveUpdate:b,splice:i}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./type.js":9}],8:[function(t,e,r){function n(t,e,r){a.forEach(function(e){r!==e&&delete t[e]}),t[r]=e[r]}function o(t,e){var r,h=i.shallowClone(e||{});a.forEach(function(e){t[e]&&n(h,t,e)}),t.$chain&&(a.slice(0,-1).forEach(function(t){delete h[t]}),h.$apply=h.$apply?i.compose(h.$apply,t.$chain):t.$chain),t.$push&&h.$push?h.$push=s.Array(h.$push)?h.$push.concat(t.$push):[h.$push].concat(t.$push):t.$push&&(h.$push=t.$push),t.$unshift&&h.$unshift?h.$unshift=s.Array(t.$unshift)?t.$unshift.concat(h.$unshift):[t.$unshift].concat(h.$unshift):t.$unshift&&(h.$unshift=t.$unshift);for(r in t)s.Object(t[r])?h[r]=o(t[r],h[r]):"$"!==r[0]&&(h[r]=t[r]);return h}var i=t("./helpers.js"),s=t("./type.js"),a=["$unset","$set","$merge","$apply"];e.exports=o},{"./helpers.js":7,"./type.js":9}],9:[function(t,e,r){function n(t,e){return e.some(function(e){return o[e](t)})}var o={};o.Array=function(t){return Array.isArray(t)},o.Object=function(t){return t&&"object"==typeof t&&!Array.isArray(t)&&!(t instanceof Function)},o.String=function(t){return"string"==typeof t},o.Number=function(t){return"number"==typeof t},o.PositiveInteger=function(t){return"number"==typeof t&&t>0&&t%1===0},o.Function=function(t){return"function"==typeof t},o.Primitive=function(t){return"string"==typeof t||"number"==typeof t||"boolean"==typeof t},o.Date=function(t){return t instanceof Date},o.NonScalar=function(t){return o.Object(t)||o.Array(t)},o.Path=function(t){var e=["String","Number","Function","Object"];return o.Array(t)?t.every(function(t){return n(t,e)}):n(t,e)},o.MixinCursor=function(t){return n(t,["String","Number","Array","Function","Cursor"])},o.MixinCursors=function(t){return n(t,["Object","Array","Function"])},o.ComplexPath=function(t){return t.some(function(t){return n(t,["Object","Function"])})},e.exports=o},{}],10:[function(t,e,r){function n(t,e){var r=new Error("baobab.update: "+e+" at path /"+t.slice(1).join("/"));return r.path=t,r}var o=t("./helpers.js"),i=t("./type.js");e.exports=function(t,e,r){if(r=r||{},!i.Object(t)&&!i.Array(t))throw Error("baobab.update: invalid target.");var s={};t={root:o.shallowClone(t)};var a=function(t,e,r,h){r=r||["root"];var u,c,l,f=r.join("|λ|"),p=r[r.length-1],d=Object.keys(e).some(function(t){return!!~["$unset","$set","$apply","$merge","$push","$unshift"].indexOf(t)});if(d){s[f]=!0;for(c in e){if("$unset"===c){var y=r[r.length-2];i.Array(t)?h[y]=o.splice(h[y],+p,1):(h[y]=o.shallowClone(t),delete h[y][p]);break}if("$set"===c){l=e.$set,t[p]=l;break}if("$apply"===c){if(u=e.$apply,"function"!=typeof u)throw n(r,"using command $apply with a non function");t[p]=u.call(null,t[p]);break}if("$merge"===c){if(l=e.$merge,!i.Object(t[p])||!i.Object(l))throw n(r,"using command $merge with a non object");t[p]=o.shallowMerge(t[p],l);break}if("$push"===c){if(l=e.$push,!i.Array(t[p]))throw n(r,"using command $push to a non array");t[p]=t[p].concat(l)}if("$unshift"===c){if(l=e.$unshift,!i.Array(t[p]))throw n(r,"using command $unshift to a non array");t[p]=[].concat(l).concat(t[p])}}}else for(c in e)t[p][c]="undefined"==typeof t[p][c]?{}:o.shallowClone(t[p][c]),a(t[p],e[c],r.concat(c),t)};return a(t,e),{data:t.root,log:Object.keys(s).map(function(t){return t.split("|λ|").slice(1)})}}},{"./helpers.js":7,"./type.js":9}],11:[function(t,e,r){function n(t,e){function r(){h&&(a=e.map(function(t){return i.solvePath(n.tree.data,t,n.tree)}))}var n=this;o.call(this),this.tree=t;var a=e,h=e.some(s.ComplexPath);this.updateHandler=function(t){var e=i.solveUpdate(t.data.log,a);e&&n.emit("update")},r(),this.tree.on("update",this.updateHandler)}var o=t("emmett"),i=t("./helpers.js"),s=t("./type.js");i.inherits(n,o),n.prototype.release=function(){this.tree.off("update",this.updateHandler),this.tree=null,this.kill()},e.exports=n},{"./helpers.js":7,"./type.js":9,emmett:3}]},{},[1])(1)});